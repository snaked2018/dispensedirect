/**
 *  @class
 *  @function QuickView
 */
if (!customElements.get('quick-view')) {
	class QuickView extends HTMLElement {
		constructor() {
			super();
		}
		connectedCallback() {
			this.cc = document.querySelector('.click-capture--product');
			this.drawer = document.getElementById('Product-Drawer');
			this.close = this.drawer.querySelector('.thb-close');
			this.product = this.closest('.product');
			this.wrapper = document.getElementById('wrapper');

			this.addEventListener('click', this.setupEventListener.bind(this));

			this.cc.addEventListener('click', this.closeQuickView.bind(this));
			this.close.addEventListener('click', this.closeQuickView.bind(this));

			document.addEventListener('keyup', (e) => {
				if (e.code) {
					if (e.code.toUpperCase() === 'ESCAPE') {
						this.closeQuickView(e);
					}
				}
			});
		}
		closeQuickView(e) {
			e.preventDefault();
			this.wrapper.classList.remove('open-quick-view');
			this.drawer.classList.remove('active');

			let popups = document.querySelectorAll('.product-popup-modal');

			if (popups.length) {
				popups.forEach((popup, i) => {
					popup.remove();
				});
			}

			setTimeout(() => {
				this.drawer.querySelector('#Product-Drawer-Content').innerHTML = '';
			}, 300);
		}
		setupEventListener(e) {
			e.preventDefault();
			let productHandle = this.dataset.productHandle,
				href = `${theme.routes.root_url}/products/${productHandle}?view=quick-view`;

			// remove double `/` in case shop might have /en or language in URL
			href = href.replace('//', '/');
			if (!href || !productHandle) {
				return;
			}
			if (this.product.classList.contains('thb-loading')) {
				return;
			}
			this.product.classList.add('thb-loading');
			fetch(href, {
				method: 'GET'
			})
				.then((response) => {
					this.product.classList.remove('thb-loading');
					return response.text();
				})
				.then(text => {
					const sectionInnerHTML = new DOMParser()
						.parseFromString(text, 'text/html')
						.querySelector('#Product-Drawer-Content').innerHTML;

					this.renderQuickview(sectionInnerHTML, href, productHandle);

				});
		}
		renderQuickview(sectionInnerHTML, href, productHandle) {
			if (sectionInnerHTML) {

				this.drawer.querySelector('#Product-Drawer-Content').innerHTML = sectionInnerHTML;

				let js_files = this.drawer.querySelector('#Product-Drawer-Content').querySelectorAll('script');

				if (js_files.length > 0) {
					var head = document.getElementsByTagName('head')[0];
					js_files.forEach((js_file, i) => {
						let script = document.createElement('script');
						script.src = js_file.src;
						head.appendChild(script);
					});
				}

				setTimeout(() => {

					if (this.drawer.querySelector('.carousel') && Flickity) {
						let flkty = Flickity.data(this.drawer.querySelector('.carousel'));

						flkty.resize();
					}
					if (Shopify && Shopify.PaymentButton) {
						Shopify.PaymentButton.init();
					}
					if (window.ProductModel) {
						window.ProductModel.loadShopifyXR();
					}
				}, 300);

				this.wrapper.classList.add('open-quick-view');
				this.drawer.classList.add('active');

				this.drawer.querySelector('.thb-close').focus();

				dispatchCustomEvent('quick-view:open', {
					productUrl: href,
					productHandle: productHandle
				});
			}
		}
	}
	customElements.define('quick-view', QuickView);
}